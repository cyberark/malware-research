rule Matanbuchus_main_stage
{
  meta: 
    author = "Ben Cohen, CyberArk"
    date = "14-04-2022"
    vesrion = "1.0"
    hash = "b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e"
    reference = ""
    description = "Yara rule for Matanbuchus Loader's main stage"
  
  strings:
    $fnva1_prime = {93 01 00 01} // 0x01000193
    $fnva1_basis = {C5 9D 1C 81} //0x811c9dc5

    $MurmurHash_const1 = {95 E9 D1 5B}
    $MurmurHash_const2 = {B9 90 6A 28}
    $MurmurHash_const3 = {57 73 2A AA}

    $import_func1 = "GetProcAddress"
    $import_func2 = "TerminateProcess"
    $import_func3 = "heapAlloc"
    $import_func4 = "LoadLibraryExW"

    $res_func_hash1 = {09 0A 7C 4A} //0x4A7C0A09 - CreateProcessA
    $res_func_hash2 = {A8 2C A6 2F} //0x2FA62CA8h - Sleep
    $res_func_hash3 = {E7 96 3B E2} //0x0E23B96E7 - InternetOpenA
    $res_func_hash4 = {39 7E AC 60} //0x60AC7E39h - CreateThread
    $res_func_hash5 = {F7 E4 42 F6} //0x0F642E4F7 - ExpandEnvironmentStringsA
    $res_func_hash6 = {A3 FF 2F 43} //0x432FFFA3 - PathFileExistsA

    $cis1 = {19 04 00 00}
    $cis2 = {C1 0A}
    $cis3 = {22 04 00 00}
    $cis4 = {2B 04 00 00}
    $cis5 = {43 08 00 00}

    $b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

    $hardcoded_key = {DA 4E 1E 00} //0x1E4EDA - might change
    
    $exported_func1 = "DllRegisterServer"
    $exported_func2 = "DllInstall"
    $exported_func3 = "DllUnRegisterServer"

  condition:
    $fnva1_prime and $fnva1_basis and 
    2 of ($MurmurHash_const*) and
    2 of ($import_func*) and
    3 of ($res_func_hash*) and
    2 of ($cis*) and
    ($b64 or $hardcoded_key or 1 of ($exported_func*) or $hardcoded_key) and
    $b64 and
    uint16(0) == 0x5A4D
}