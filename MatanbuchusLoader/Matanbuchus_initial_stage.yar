rule Matanbuchus_initial_stage
{
  meta: 
    author = "Ben Cohen, CyberArk"
    date = "03-01-2022"
    vesrion = "1.0"
    hash = "32814d7581dcbcfeca8fce229bdb12bf92f006aea54c3f393cbbef341c897877"
    reference = ""
    description = "Yara rule for Matanbuchus Loader's initial stage"
  
  strings:
    $fnva1_prime = {93 01 00 01} // 0x01000193
    $fnva1_basis = {C5 9D 1C 81} //0x811c9dc5
    
    $MurmurHash_const1 = {95 E9 D1 5B}
    $MurmurHash_const2 = {B9 90 6A 28}
    $MurmurHash_const3 = {57 73 2A AA}

    $res_func_hash1 = {F7 E4 42 F6} //0xF642E4F7
    $res_func_hash2 = {1B F9 D0 B3} //0xB3D0F91B
    $res_func_hash3 = {0F 07 B2 53} //0x53B2070F
    $res_func_hash4 = {E7 96 3B E2} //0xE23B96E7
    $res_func_hash5 = {4A C4 07 7F} //0x7F07C44A
    $res_func_hash6 = {28 D0 2E 99} //0x992ED028
    $res_func_hash7 = {75 E7 11 1A} //0x1A11E775
    $res_func_hash8 = {E3 36 1A 88} //0x881A36E3
    $res_func_hash9 = {97 D2 6E 3B} //0x3B6ED297

    $resolve_from1 = "Shlwapi.dll" wide
    $resolve_from2 = "Kernel32.dll" wide
    
    $obf_call_str1 = "GetProcAddress"
    $obf_call_str2 = "CloseHandle"
    $obf_call_str3 = "ExpandEnvironmentStringsA"
    $obf_call_str4 = "VirtualAlloc"
    $obf_call_str5 = "LoadLibraryA"
    
    $hardcoded_key = {FE C7 1D 00} //0x1DC7FE - might change

    $exported_func1 = "DllRegisterServer"
    $exported_func2 = "DllInstall"
    $exported_func3 = "DllUnRegisterServer"

  condition:
    $fnva1_prime and $fnva1_basis and
    2 of ($MurmurHash_const*) and
    4 of ($res_func_hash*) and
    3 of ($obf_call_str*) and
    (1 of ($resolve_from*) or 1 of ($exported_func*) or $hardcoded_key) and
    uint16(0) == 0x5A4D
}